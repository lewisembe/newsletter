# Scripts - Utility Tools

Collection of utility scripts for newsletter pipeline maintenance, testing, and analysis.

## üìä Analysis & Debugging

### `analyze_context_report.py` ‚ú® NEW
**Purpose:** Analyze context reports generated by Stage 05

Quick verification and debugging of newsletter generation:
- Extraction success rates
- Category matching verification
- Failed extraction details
- Distribution statistics

**Usage:**
```bash
# Analyze specific report
python scripts/analyze_context_report.py data/newsletters/context_report_noticias_diarias_2025-11-14_*.json

# Analyze latest report
python scripts/analyze_context_report.py --latest

# With checklist
python scripts/analyze_context_report.py --latest --checklist

# Show failed extractions details
python scripts/analyze_context_report.py --latest --failed
```

**Example output:**
```
üìä CONTEXT REPORT SUMMARY
================================================================================

üìù Newsletter: noticias_diarias
üìÖ Run Date: 2025-11-14
üïê Generated: 2025-11-14T10:30:45+01:00

‚öôÔ∏è  CONFIGURATION
   ‚Ä¢ Max articles: 20
   ‚Ä¢ Top with content: 10
   ‚Ä¢ Template: default
   ‚Ä¢ Model: gpt-4o-mini

üìÇ CATEGORIES
   ‚Ä¢ Expected: ['Econom√≠a', 'Pol√≠tica', 'Geopol√≠tica']
   ‚Ä¢ Ranked file: ['Econom√≠a', 'Pol√≠tica', 'Geopol√≠tica']
   ‚úÖ Categories match!

üìä EXTRACTION STATS
   ‚Ä¢ Requested: 10
   ‚Ä¢ Success: 8
   ‚Ä¢ Failed: 2
   ‚Ä¢ Success rate: 80.0%
   ‚úÖ Excellent extraction rate!
```

---

### `analyze_failures.py`
**Purpose:** Analyze Stage 04 content extraction failures

Identifies patterns in extraction failures:
- Which sources fail most often
- Common error types
- Paywall issues

**Usage:**
```bash
python scripts/analyze_failures.py
```

---

## üóÑÔ∏è Database Maintenance

### `migrate_categories.py`
**Purpose:** Migrate articles to new category schema

Use when updating `config/categories.yml` with new categories.

**Usage:**
```bash
python scripts/migrate_categories.py
```

---

### `migrate_stage04_schema.py`
**Purpose:** Migrate database to Stage 04 schema

Adds Stage 04 columns to existing `urls` table:
- `full_content`
- `extraction_status`
- `extraction_error`
- `word_count`
- `content_extraction_method`
- `archive_url`

**Usage:**
```bash
python scripts/migrate_stage04_schema.py
```

---

### `clean_html_from_titles.py`
**Purpose:** Remove HTML tags from article titles in database

Cleans up malformed titles from Stage 01.

**Usage:**
```bash
python scripts/clean_html_from_titles.py
```

---

## üîê Authentication & Cookies

### `import_browser_cookies.py`
**Purpose:** Import cookies from browser for authenticated content extraction

Supports Chrome, Firefox, Safari, Edge.

**Usage:**
```bash
# Import from Chrome
python scripts/import_browser_cookies.py chrome

# Import from Firefox
python scripts/import_browser_cookies.py firefox

# Specific domain
python scripts/import_browser_cookies.py chrome --domain ft.com
```

**Output:** `config/cookies/browser_cookies.json`

---

### `import_cookies.py`
**Purpose:** Manual cookie import utility

Alternative to browser cookie import when you have cookies in other formats.

**Usage:**
```bash
python scripts/import_cookies.py
```

---

## üß™ Testing & POCs

### `test_content_extraction.py`
**Purpose:** Test content extraction for specific URLs

Comprehensive testing of Stage 04 extraction logic:
- XPath cache lookup
- Newspaper3k extraction
- Readability fallback
- LLM XPath discovery
- Archive.today bypass

**Usage:**
```bash
# Test single URL
python scripts/test_content_extraction.py "https://example.com/article"

# Test with specific method
python scripts/test_content_extraction.py "https://..." --method xpath_cache

# Test with archive bypass
python scripts/test_content_extraction.py "https://..." --use-archive
```

---

### `test_extraction_quick.py`
**Purpose:** Quick extraction test without full pipeline

Lightweight version of `test_content_extraction.py` for rapid testing.

**Usage:**
```bash
python scripts/test_extraction_quick.py "https://example.com/article"
```

---

### `poc_authenticated_extraction.py`
**Purpose:** POC for authenticated content extraction

Proof-of-concept for extracting content from subscription-based sites using cookies.

**Usage:**
```bash
python scripts/poc_authenticated_extraction.py
```

---

### `test_global_rules.py`
**Purpose:** Test URL classification rules

Validates `config/url_classification_rules.yml` patterns work correctly.

**Usage:**
```bash
python scripts/test_global_rules.py
```

---

## üîß Maintenance Workflows

### Initial Setup
```bash
# 1. Migrate database to latest schema
python scripts/migrate_stage04_schema.py

# 2. Import browser cookies for paywalled content
python scripts/import_browser_cookies.py chrome

# 3. Test extraction on sample URLs
python scripts/test_content_extraction.py "https://ft.com/sample-article"
```

### Debugging Extraction Issues
```bash
# 1. Analyze failures from previous run
python scripts/analyze_failures.py

# 2. Check context report from Stage 05
python scripts/analyze_context_report.py --latest --failed

# 3. Test problematic URL
python scripts/test_content_extraction.py "https://problematic-url.com/article"
```

### Category Updates
```bash
# 1. Edit config/categories.yml
# 2. Migrate existing articles
python scripts/migrate_categories.py
```

---

## üìù Best Practices

1. **Always backup database before migrations**
   ```bash
   cp data/news.db data/news.db.backup
   ```

2. **Use `--latest` flag for quick checks**
   ```bash
   python scripts/analyze_context_report.py --latest
   ```

3. **Test extraction on new sources before adding to pipeline**
   ```bash
   python scripts/test_content_extraction.py "https://newsource.com/article"
   ```

4. **Refresh browser cookies periodically** (especially for FT, Bloomberg)
   ```bash
   python scripts/import_browser_cookies.py chrome
   ```

---

## üÜï Recent Additions

- **2025-11-14:** Added `analyze_context_report.py` - Stage 05 context report analyzer
- **2025-11-13:** Added Stage 04 testing utilities
- **2025-11-12:** Added cookie import scripts

---

**See also:**
- Stage 05 Context Reports: [`stages/CONTEXT_REPORT_FORMAT.md`](../stages/CONTEXT_REPORT_FORMAT.md)
- Stage 04 Documentation: [`stages/README_STAGE04.md`](../stages/README_STAGE04.md)
